# Week 2 Day 8 - 실전 추적 시스템 구축 및 중요한 발견

**날짜**: 2024-10-12  
**소요 시간**: 3시간  
**타입**: 실전 구현 & 전략적 전환점

---

## 목표

Day 7에서 Tracker의 가능성을 확인한 후,
실제로 사용 가능한 추적 도구를 만들고
여러 랠리 데이터를 수집하는 것.

---

## 데이터 품질의 중요성

### 기존 영상 문제

**tennis_sample_1.mp4**:
- YouTube 압축
- 720p 해상도
- 공 크기: 5-10픽셀
- 오래된 영상

**추적 결과**:
- Tracker 작동하지만 불안정
- 자주 놓침

### 새 영상 확보

**Sinner vs Murray 연습 랠리**:
- URL: https://youtu.be/qmuuzYkbKX0
- 1080p 고화질
- 25분 분량
- 실제 크기: 1.1GB

**다운로드**:
```bash
yt-dlp -f "best[height<=1080]" \
       -o "sinner_murray.mp4" \
       "https://youtu.be/qmuuzYkbKX0"
```

**추적 결과**:
- ✅ **100% 추적 성공!** (테스트 구간)
- 부드러운 추적
- 명확한 경계 박스

**교훈**:
> "기술도 중요하지만 데이터 품질이 핵심"

---

## 인터랙티브 추적 시스템 구현

### 요구사항

**사용자 친화적 도구**:
1. 영상 재생/일시정지
2. 원하는 순간에 초기화
3. 여러 랠리 연속 처리
4. 자동 데이터 저장

### 구현 과정

**버전 1: test_interactive_tracking.py**
- 복잡한 클래스 구조
- 문제: R 키 반응 느림, Q 키 종료 안 됨

**버전 2: test_rally_tracker_simple.py**
- 단순화
- 문제: 여전히 반응성 이슈

**버전 3: test_rally_tracker_v2.py** ⭐
- 완전 개선
- 모든 문제 해결

### 최종 기능

**조작법**:
```
SPACE: 일시정지/재생
R: 랠리 추적 시작 (일시정지 시)
S: 현재 랠리 저장
Q/ESC: 종료
```

**자동 저장**:
- 각 랠리: `rally_01.csv`, `rally_02.csv`, ...
- 통합: `all_rallies.csv`

**CSV 형식**:
```csv
frame,x,y,width,height,success
259,1147,574,59,60,1
260,1150,577,59,60,1
...
```

---

## 핵심 발견: 추적의 근본적 한계

### 실전 테스트 결과

**좋은 구간** ✅:
- 공이 날아가는 중
- 배경 단순
- 100% 추적 성공

**실패 구간** ❌:
- 네트 통과 시: 하얀 네트 때문에 놓침
- 선수 타격 시: 라켓/몸에 가려져서 놓침

### Occlusion (가려짐) 문제

**핵심 장애물 2가지**:

**1. 네트** 🥅:
```
공 → 네트 → ✗ 추적 실패
     ↑
   하얀색, 복잡한 패턴
```

**2. 전방 선수** 🎾:
```
공 → 선수 (타격 준비) → ✗ 추적 실패
     ↑
   라켓 + 몸 = 완전 가림
```

**결과**:
- 한 랠리 내에서도 여러 번 끊김
- 연속 추적 불가능
- "완벽한 공 추적"은 비현실적

---

## 버드뷰(탑다운) 검토

### 장점

**측면뷰 (현재)**:
```
선수 ───→ 네트 ───→ 선수
       ↑ 가림  ↑ 가림
```

**버드뷰 (위에서)**:
```
    선수
      ↓
    ━━━ (네트는 얇은 선)
      ↓  
    선수
    
→ 가림 최소화
→ 궤적 명확
```

### 현실

**문제점**:
- 버드뷰 영상 구하기 매우 어려움
- 드론 또는 천장 카메라 필요
- 일반 경기/연습 영상 = 대부분 측면뷰
- Hawkeye 같은 시스템 데이터 = 비공개

**결론**: 현실적으로 어려움

---

## 전략적 전환: 선수 추적

### 핵심 통찰

> "선수가 공이 아닌 곳으로 움직일 일은 거의 없다"

**의미**:
```
선수 움직임 ≈ 공의 위치 + 전략적 판단

선수 추적 = 간접적 공 추적 + α
```

### Day 6 발견 재확인

**Background Subtraction 성능**:
- 선수 검출: **거의 100%** ✅
- 공 검출: 50% ❌

**이유**:
- 선수 크기: 100-200픽셀 (크고 명확)
- 공 크기: 5-10픽셀 (작고 흐릿)

**결론**:
> "이미 잘 작동하는 기술 활용하기"

---

## 선수 추적의 가치

### 얻을 수 있는 데이터

**1. 위치 정보**:
- 매 프레임 (x, y) 좌표
- 이동 속도
- 이동 방향

**2. 코트 커버리지**:
```
히트맵:
┌─────────────┐
│ ████░░░░░░  │  전방 선수 (공격적)
│ ████████░░  │
│─────────────│  네트
│ ░░████████  │
│ ░░░░░░████  │  후방 선수 (수비적)
└─────────────┘
```

**3. 움직임 패턴**:
- 좌우 이동 vs 전후 이동
- 빠른 반응 vs 느린 반응
- 전진 vs 후퇴

### 스타일 분류 가능

**공격형**:
- 네트 가까이 (전진)
- 넓은 코트 커버리지
- 빠른 움직임

**수비형**:
- 베이스라인 뒤 (후퇴)
- 좁은 코트 커버리지
- 안정적 포지션

**균형형**:
- 베이스라인 주변
- 상황별 대응

---

## 프로젝트 방향 재설정

### 변경 전
```
"테니스 공 추적 → 궤적 분석 → 플레이어 스타일 분류"
         ↑
    매우 어려움
    완벽한 추적 불가능
```

### 변경 후 ⭐
```
"선수 움직임 추적 → 패턴 분석 → 플레이어 스타일 분류"
         ↑
    기술적으로 가능
    의미 있는 결과
    원래 목표와 유사
```

### 새로운 로드맵

**Month 1 (Week 2-4)**: 선수 추적
- Week 2 Day 9-10: 두 선수 동시 추적
- Week 3: 위치 데이터 수집
- Week 4: 데이터 정제

**Month 2 (Week 5-8)**: 패턴 분석
- 히트맵
- 이동 거리/속도
- 포지셔닝 패턴

**Month 3 (Week 9-12)**: 스타일 분류
- 특징 추출
- 머신러닝
- 최종 시스템

---

## 기술적 성과

### 완성된 도구

**test_rally_tracker_v2.py**:
- ✅ 인터랙티브 UI
- ✅ 여러 랠리 처리
- ✅ 자동 CSV 저장
- ✅ 반응성 좋음
- ✅ 안정적 종료

### 핵심 기술

**1. 키 입력 처리**:
```python
key = cv2.waitKey(1) & 0xFF
if key == ord('q') or key == 27:  # Q 또는 ESC
```

**2. 창 관리**:
```python
# ROI 전 메인 창 닫기
cv2.destroyWindow(window_name)
# ROI 후 재생성
cv2.namedWindow(window_name)
```

**3. 확실한 종료**:
```python
cv2.destroyAllWindows()
for _ in range(10):
    cv2.waitKey(1)  # macOS 문제 해결
```

---

## 배운 교훈

### 1. 데이터 품질 = 프로젝트 성공의 50%

**경험**:
- 낮은 화질 영상 → 50% 성공
- 높은 화질 영상 → 100% 성공

**교훈**:
> "좋은 데이터가 복잡한 알고리즘보다 중요할 수 있다"

### 2. 완벽을 추구하지 말 것

**Week 1-2 초반**:
- "완벽한 자동 공 검출!"
- → 실패

**Week 2 Day 8**:
- "현실적으로 가능한 것"
- → 선수 추적으로 전환

**교훈**:
> "80% 완성도의 다른 접근 > 20% 완성도의 완벽 추구"

### 3. 실패도 가치 있다

**공 추적 시도**:
- 2주 투자
- 완벽한 추적 실패

**하지만**:
- Occlusion 문제 이해
- Tracker 기술 습득
- 더 나은 방향 발견

**교훈**:
> "실패를 통해 배우고 방향을 수정하는 것이 진짜 프로젝트"

### 4. 원래 목표 기억하기

**최종 목표**:
- "플레이어 스타일 분류"

**수단**:
- 공 추적? (어려움)
- 선수 추적? (가능!)

**둘 다 같은 목표 달성 가능**

**교훈**:
> "수단에 집착하지 말고 목표에 집중"

---

## 실전 분석 예시

### Sinner vs Murray 영상 분석 가능한 것

**1. 평균 위치 비교**:
```python
sinner_avg_y = mean(sinner_positions_y)
murray_avg_y = mean(murray_positions_y)

if sinner_avg_y < murray_avg_y:
    print("Sinner가 더 공격적 (전방 포지션)")
```

**2. 이동 거리**:
```python
total_distance = sum(frame_to_frame_distances)
# 많이 움직임 = 수비형? 또는 기민함?
```

**3. 코트 사용 범위**:
```python
x_range = max_x - min_x  # 좌우
y_range = max_y - min_y  # 전후

# 넓은 범위 = 적극적 플레이
```

**4. 반응 속도**:
```python
# 방향 전환 시점의 속도 변화
```

---

## 기술 스택 정리 (Week 2까지)

### 습득한 기술

**Computer Vision**:
- OpenCV 기초
- Background Subtraction (MOG2, KNN)
- 형태학적 연산
- OpenCV Tracker (CSRT)
- ROI 설정

**Python**:
- 클래스 설계
- 파일 I/O (CSV)
- 인터랙티브 UI

**문제 해결**:
- 디버깅
- 성능 최적화
- 사용성 개선

---

## 다음 단계 (Week 2 Day 9-10)

### Day 9: 두 선수 동시 추적

**목표**:
- Background Subtraction
- 큰 객체 2개 찾기 (선수)
- 각 선수 ID 부여
- 위치 데이터 저장

**출력**:
```csv
frame, player1_x, player1_y, player2_x, player2_y
```

### Day 10: 기본 분석

**목표**:
- 궤적 시각화
- 히트맵 생성
- 평균 위치 계산
- Week 2 정리

---

## 코드 산출물

**주요 파일**:
1. `test_interactive_tracking.py` - 초기 버전
2. `test_rally_tracker_simple.py` - 단순화 버전
3. **`test_rally_tracker_v2.py`** - 최종 완성 ⭐

**데이터 구조**:
```
data/
├── sinner_murray.mp4 (1.1GB)
└── rallies/
    ├── rally_01.csv
    ├── rally_02.csv
    └── all_rallies.csv
```

---

## 참고 자료

- [OpenCV Tracker Tutorial](https://docs.opencv.org/4.x/d9/df8/group__tracking.html)
- [CSRT Tracker Paper](https://arxiv.org/abs/1611.08461)
- [Player Movement Analysis in Tennis](https://scholar.google.com/scholar?q=tennis+player+movement+analysis)

---

## 회고

오늘은 프로젝트의 **전환점**이었다.

**감정의 흐름**:
- 아침: "좋은 영상으로 완벽히 추적하자!"
- 오후: "100% 추적 성공!" → 희열
- 저녁: "하지만 네트/선수에서 계속 실패..." → 좌절
- 밤: "선수 추적으로 전환!" → 새로운 희망

**가장 중요한 깨달음**:
> "실패는 잘못된 방향을 알려주는 나침반이다"

공 추적에 2주를 써서 "실패"했지만,
- Tracker 기술 배웠고
- 문제의 본질 이해했고
- 더 나은 방향 찾았다

이게 진짜 프로젝트다.

**내일 Day 9**:
완전히 새로운 접근으로 시작한다.
선수 추적 시스템 구축.
이번엔 잘 될 것 같다.

---

## 프로젝트 상태

**진행률**: Month 1, Week 2 Day 8 완료 (17%)

**현재 상태**:
- ✅ 문제 정의
- ✅ 데이터 수집
- ✅ 기술 검증
- ✅ 방향 설정
- ⏳ 구현 (시작 예정)

**다음 마일스톤**: 
- Week 2 완료 (Day 10)
- 첫 번째 분석 결과